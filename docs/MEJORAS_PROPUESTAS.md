# üìã An√°lisis del Proyecto y Mejoras Propuestas

**Fecha:** 7 de Octubre, 2025  
**Proyecto:** ApareText v1.0  
**Arquitectura Actual:** Electron + FastAPI + SQLite

---

## üìä Estado Actual del Proyecto

### ‚úÖ Completado (90%)
- ‚úÖ Core backend (Python) con modelos, DB y parser
- ‚úÖ API REST FastAPI funcional (15+ endpoints)
- ‚úÖ Aplicaci√≥n Electron con palette y manager
- ‚úÖ Glassmorphism UI unificada
- ‚úÖ WYSIWYG editor con Quill.js
- ‚úÖ Filtrado por tags en palette
- ‚úÖ CRUD completo de snippets
- ‚úÖ Template parser con variables y funciones
- ‚úÖ Export/Import JSON

### ‚ö†Ô∏è Incompleto o Sin Implementar
- ‚ùå **Formulario de variables** (snippets con {{variables}} no piden valores)
- ‚ùå **Tests** (carpeta `tests/` vac√≠a)
- ‚ùå **Detector de abreviaturas** (no funciona ;abbr + Tab)
- ‚ùå **Scope filtering** (no filtra por app/dominio)
- ‚ùå **WebSocket real-time** (implementado pero no usado)
- ‚ùå **Extensi√≥n de navegador** (solo documentado)
- ‚ùå **Inserci√≥n real de texto** (solo clipboard)
- ‚ùå **Estad√≠sticas de uso** (endpoint existe pero no UI)

---

## üéØ Mejoras Propuestas por Prioridad

### üî¥ **PRIORIDAD CR√çTICA** (Funcionalidad B√°sica Rota)

#### 1. **Implementar Formulario de Variables** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
**Problema:** Cuando un snippet tiene variables `{{nombre}}`, se expande sin pedir valores.

**Impacto:** Funcionalidad core no funcional.

**Soluci√≥n:**
```javascript
// palette.html - Detectar variables y mostrar formulario
async function expandSnippet(snippet) {
    // 1. Extraer variables del template
    const variables = extractVariables(snippet.content_text || snippet.content_html);
    
    // 2. Si hay variables, mostrar formulario modal
    if (variables.length > 0) {
        const values = await showVariableForm(snippet, variables);
        if (!values) return; // Usuario cancel√≥
        
        // 3. Expandir con valores
        await ipcRenderer.invoke('expand-snippet', snippet.id, values);
    } else {
        // Sin variables, expandir directo
        await ipcRenderer.invoke('expand-snippet', snippet.id, {});
    }
}

function showVariableForm(snippet, variables) {
    // Crear modal din√°mico con inputs para cada variable
    // Usar snippet.variables[] para metadata (label, placeholder, required)
    // Retornar Promise<object> con valores o null si cancel√≥
}
```

**Archivos a modificar:**
- `electron-app/palette.html` (agregar modal y l√≥gica)
- `electron-app/manager.html` (igual para preview)

**Estimaci√≥n:** 4-6 horas

---

#### 2. **Detector de Abreviaturas Global** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
**Problema:** No detecta cuando escribes `;firma` + Tab para expandir autom√°ticamente.

**Impacto:** Funcionalidad principal del text-expander no funciona.

**Soluci√≥n:**
Usar `node-key-sender` (ya en dependencies) o `iohook` para capturar teclas globales:

```javascript
// main.js - Agregar listener de teclado global
const iohook = require('iohook');

let keyBuffer = [];
let snippetsMap = {}; // {";firma": snippetId}

async function startAbbreviationDetector() {
    // Cargar snippets con abreviaturas
    const snippets = await axios.get(`${API_URL}/api/snippets`);
    snippets.data.forEach(s => {
        if (s.abbreviation) {
            snippetsMap[s.abbreviation] = s.id;
        }
    });
    
    // Escuchar teclas
    iohook.on('keypress', (event) => {
        const char = String.fromCharCode(event.rawcode);
        keyBuffer.push(char);
        
        // Mantener buffer corto
        if (keyBuffer.length > 50) keyBuffer.shift();
        
        // Buscar coincidencias
        const bufferStr = keyBuffer.join('');
        for (const [abbr, snippetId] of Object.entries(snippetsMap)) {
            if (bufferStr.endsWith(abbr)) {
                // ¬°Match! Expandir snippet
                expandAbbreviation(snippetId, abbr.length);
                keyBuffer = [];
                break;
            }
        }
    });
    
    iohook.start();
}

async function expandAbbreviation(snippetId, abbrLength) {
    // 1. Borrar abreviatura (simular backspaces)
    // 2. Obtener snippet y expandir
    // 3. Insertar contenido
}
```

**Dependencias necesarias:**
```bash
npm install iohook
```

**Archivos a crear/modificar:**
- `electron-app/main.js` (agregar detector)
- Agregar toggle on/off en tray menu

**Estimaci√≥n:** 8-12 horas (complejidad de keyboard hooks cross-platform)

---

### üü° **PRIORIDAD ALTA** (Mejoras Importantes)

#### 3. **Inserci√≥n Real de Texto (Robot.js)** ‚≠ê‚≠ê‚≠ê‚≠ê
**Problema:** Actualmente solo copia al clipboard. El usuario debe hacer Ctrl+V manualmente.

**Soluci√≥n:**
```bash
npm install robotjs
```

```javascript
// main.js
const robot = require('robotjs');

async function insertText(text) {
    // Esperar 100ms para cambiar de ventana
    await new Promise(r => setTimeout(r, 100));
    
    // Simular Ctrl+V autom√°ticamente
    robot.keyTap('v', 'control');
    
    // O escribir car√°cter por car√°cter (m√°s lento pero m√°s confiable)
    // robot.typeString(text);
}
```

**Ventajas:**
- Expansi√≥n autom√°tica sin intervenci√≥n del usuario
- Experiencia similar a Alfred/TextExpander

**Archivos a modificar:**
- `electron-app/main.js` (funci√≥n insertText)

**Estimaci√≥n:** 2-3 horas

---

#### 4. **Tests Unitarios y de Integraci√≥n** ‚≠ê‚≠ê‚≠ê‚≠ê
**Problema:** Carpeta `tests/` vac√≠a. No hay cobertura de tests.

**Soluci√≥n:**
```bash
# Instalar pytest
pip install pytest pytest-asyncio httpx
```

**Estructura propuesta:**
```
tests/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ test_database.py
‚îÇ   ‚îú‚îÄ‚îÄ test_models.py
‚îÇ   ‚îú‚îÄ‚îÄ test_snippet_manager.py
‚îÇ   ‚îî‚îÄ‚îÄ test_template_parser.py
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ test_api.py
‚îÇ   ‚îî‚îÄ‚îÄ test_websocket.py
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ test_full_flow.py
```

**Ejemplo de test:**
```python
# tests/core/test_template_parser.py
import pytest
from core.template_parser import TemplateParser

def test_extract_variables():
    parser = TemplateParser()
    template = "Hola {{nombre}}, tu email es {{email}}"
    variables = parser.extract_variables(template)
    assert variables == ["nombre", "email"]

def test_parse_with_variables():
    parser = TemplateParser()
    result = parser.parse("Hola {{nombre}}", {"nombre": "Juan"})
    assert result == "Hola Juan"

def test_cursor_position():
    parser = TemplateParser()
    result, cursor = parser.parse_with_cursor_position(
        "Hola {{nombre}}{{|}}", {"nombre": "Juan"}
    )
    assert result == "Hola Juan"
    assert cursor == len("Hola Juan")
```

**Archivos a crear:**
- 10+ archivos de test (ver estructura)
- `pytest.ini` (configuraci√≥n)
- `.github/workflows/tests.yml` (CI/CD)

**Estimaci√≥n:** 12-16 horas

---

#### 5. **Filtrado por Scope (Apps/Dominios)** ‚≠ê‚≠ê‚≠ê‚≠ê
**Problema:** Los snippets con `scope_type=apps` o `domains` no se filtran seg√∫n la app activa.

**Soluci√≥n:**
```javascript
// main.js - Detectar app activa (Windows)
const activeWin = require('active-win');

async function getActiveContext() {
    const win = await activeWin();
    return {
        app: win?.owner?.name,  // "chrome.exe"
        title: win?.title,      // "Twitter - Google Chrome"
        domain: extractDomain(win?.title)
    };
}

function extractDomain(title) {
    // Extraer dominio del t√≠tulo de navegador
    const match = title?.match(/(?:https?:\/\/)?(?:www\.)?([^\s/]+)/);
    return match ? match[1] : null;
}

// Al expandir, filtrar snippets por scope
ipcMain.handle('get-snippets', async () => {
    const context = await getActiveContext();
    const allSnippets = await axios.get(`${API_URL}/api/snippets`);
    
    return allSnippets.data.filter(s => {
        if (s.scope_type === 'global') return true;
        if (s.scope_type === 'apps') {
            return s.scope_values.some(app => 
                context.app?.toLowerCase().includes(app.toLowerCase())
            );
        }
        if (s.scope_type === 'domains') {
            return s.scope_values.some(domain => 
                context.domain?.includes(domain)
            );
        }
        return true;
    });
});
```

**Dependencias:**
```bash
npm install active-win
```

**Archivos a modificar:**
- `electron-app/main.js` (l√≥gica de filtrado)
- `server/api.py` (agregar filtros a endpoints)

**Estimaci√≥n:** 6-8 horas

---

### üü¢ **PRIORIDAD MEDIA** (Mejoras de UX)

#### 6. **Estad√≠sticas de Uso en UI** ‚≠ê‚≠ê‚≠ê
**Problema:** El endpoint `/api/stats` existe pero no hay UI.

**Soluci√≥n:**
Agregar pesta√±a "üìä Stats" en el manager:

```html
<!-- manager.html -->
<div class="stats-section" id="statsSection" style="display: none;">
    <h2>Estad√≠sticas de Uso</h2>
    <div class="stat-card">
        <div class="stat-value" id="totalUses">0</div>
        <div class="stat-label">Expansiones Totales</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="topSnippet">-</div>
        <div class="stat-label">Snippet M√°s Usado</div>
    </div>
    <canvas id="usageChart"></canvas>
</div>
```

```javascript
async function loadStats() {
    const stats = await ipcRenderer.invoke('get-stats');
    document.getElementById('totalUses').textContent = stats.total_uses;
    // Render chart con Chart.js
    renderUsageChart(stats);
}
```

**Dependencias:**
```bash
npm install chart.js
```

**Archivos a modificar:**
- `electron-app/manager.html` (agregar pesta√±a)
- `electron-app/main.js` (agregar IPC handler)

**Estimaci√≥n:** 4-5 horas

---

#### 7. **Backup/Restore desde UI** ‚≠ê‚≠ê‚≠ê
**Problema:** Export/Import existen en API pero no hay botones en UI.

**Soluci√≥n:**
```html
<!-- manager.html - Agregar toolbar buttons -->
<button class="btn-icon" onclick="exportSnippets()">
    üíæ Export
</button>
<button class="btn-icon" onclick="importSnippets()">
    üì• Import
</button>
```

```javascript
async function exportSnippets() {
    const { filePath } = await electron.remote.dialog.showSaveDialog({
        defaultPath: `aparetext_backup_${new Date().toISOString()}.json`,
        filters: [{ name: 'JSON', extensions: ['json'] }]
    });
    
    if (filePath) {
        const data = await ipcRenderer.invoke('export-snippets');
        await fs.writeFile(filePath, JSON.stringify(data, null, 2));
        alert('‚úÖ Snippets exportados correctamente');
    }
}

async function importSnippets() {
    const { filePaths } = await electron.remote.dialog.showOpenDialog({
        filters: [{ name: 'JSON', extensions: ['json'] }],
        properties: ['openFile']
    });
    
    if (filePaths[0]) {
        const content = await fs.readFile(filePaths[0], 'utf8');
        await ipcRenderer.invoke('import-snippets', JSON.parse(content));
        await loadSnippets();
        alert('‚úÖ Snippets importados correctamente');
    }
}
```

**Archivos a modificar:**
- `electron-app/manager.html` (agregar botones)
- `electron-app/main.js` (agregar IPC handlers)

**Estimaci√≥n:** 3-4 horas

---

#### 8. **B√∫squeda Fuzzy Mejorada** ‚≠ê‚≠ê‚≠ê
**Problema:** La b√∫squeda actual es simple `.includes()`. No soporta typos ni b√∫squeda inteligente.

**Soluci√≥n:**
```bash
npm install fuse.js
```

```javascript
// palette.html
const Fuse = require('fuse.js');

const fuse = new Fuse(allSnippets, {
    keys: ['name', 'abbreviation', 'tags', 'content_text'],
    threshold: 0.3,  // Tolerancia a typos
    ignoreLocation: true
});

function searchSnippets(query) {
    if (!query) return allSnippets;
    return fuse.search(query).map(result => result.item);
}
```

**Ventajas:**
- B√∫squeda tolerante a errores tipogr√°ficos
- B√∫squeda por relevancia
- B√∫squeda multi-campo

**Archivos a modificar:**
- `electron-app/palette.html` (reemplazar b√∫squeda)

**Estimaci√≥n:** 2-3 horas

---

#### 9. **Preview en Tiempo Real** ‚≠ê‚≠ê‚≠ê
**Problema:** Al editar un snippet, no ves c√≥mo se ver√° el resultado final.

**Soluci√≥n:**
```html
<!-- manager.html -->
<div class="preview-panel">
    <h3>Vista Previa</h3>
    <div id="snippetPreview" class="preview-content"></div>
</div>
```

```javascript
// Actualizar preview en tiempo real
contentInput.addEventListener('input', updatePreview);

function updatePreview() {
    const template = contentInput.value;
    const testVars = {};
    
    // Llenar variables con placeholders
    const variables = parser.extract_variables(template);
    variables.forEach(v => {
        testVars[v] = `[${v}]`;
    });
    
    const preview = parser.parse(template, testVars);
    document.getElementById('snippetPreview').innerHTML = preview;
}
```

**Archivos a modificar:**
- `electron-app/manager.html` (agregar panel)

**Estimaci√≥n:** 2-3 horas

---

### üîµ **PRIORIDAD BAJA** (Mejoras Opcionales)

#### 10. **Hotkey Personalizable** ‚≠ê‚≠ê
Permitir cambiar Ctrl+Space por otro atajo.

```javascript
// Agregar en settings
function registerCustomHotkey(hotkey) {
    globalShortcut.unregisterAll();
    globalShortcut.register(hotkey, showPalette);
}
```

**Estimaci√≥n:** 2 horas

---

#### 11. **Themes (Dark/Light Mode)** ‚≠ê‚≠ê
Agregar tema oscuro.

```css
/* palette.html */
[data-theme="dark"] {
    --bg-color: rgba(30, 30, 40, 0.95);
    --text-color: rgba(255, 255, 255, 0.9);
    --border-color: rgba(255, 255, 255, 0.1);
}
```

**Estimaci√≥n:** 3-4 horas

---

#### 12. **Snippets Compartidos (Cloud Sync)** ‚≠ê
Sincronizaci√≥n con Dropbox/Google Drive.

**Estimaci√≥n:** 16-20 horas

---

## üèóÔ∏è Mejoras de Arquitectura

### 1. **Separar L√≥gica de UI**
Actualmente todo el c√≥digo JS est√° en los HTML. Mejor:
```
electron-app/
‚îú‚îÄ‚îÄ main.js
‚îú‚îÄ‚îÄ preload.js
‚îú‚îÄ‚îÄ renderer/
‚îÇ   ‚îú‚îÄ‚îÄ palette.js
‚îÇ   ‚îú‚îÄ‚îÄ manager.js
‚îÇ   ‚îî‚îÄ‚îÄ shared.js
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îú‚îÄ‚îÄ palette.css
‚îÇ   ‚îî‚îÄ‚îÄ manager.css
‚îî‚îÄ‚îÄ views/
    ‚îú‚îÄ‚îÄ palette.html
    ‚îî‚îÄ‚îÄ manager.html
```

---

### 2. **Estado Global con Vuex/Redux**
Evitar pasar snippets entre ventanas manualmente.

---

### 3. **Modularizar API**
```python
server/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ snippets.py
‚îÇ   ‚îú‚îÄ‚îÄ stats.py
‚îÇ   ‚îî‚îÄ‚îÄ export.py
‚îú‚îÄ‚îÄ middleware/
‚îî‚îÄ‚îÄ utils/
```

---

## üìà Roadmap Sugerido

### **Sprint 1 (1-2 semanas)** - Funcionalidad Core
1. ‚úÖ Formulario de variables
2. ‚úÖ Detector de abreviaturas
3. ‚úÖ Inserci√≥n real de texto
4. ‚úÖ Tests b√°sicos

### **Sprint 2 (1 semana)** - UX
5. ‚úÖ Scope filtering
6. ‚úÖ Estad√≠sticas en UI
7. ‚úÖ B√∫squeda fuzzy
8. ‚úÖ Backup/Restore UI

### **Sprint 3 (1 semana)** - Polish
9. ‚úÖ Preview en tiempo real
10. ‚úÖ Hotkey personalizable
11. ‚úÖ Dark mode
12. ‚úÖ Refactoring arquitectura

### **Sprint 4 (2-3 semanas)** - Extensi√≥n Browser
13. ‚úÖ Extensi√≥n Chrome/Firefox
14. ‚úÖ WebSocket real-time
15. ‚úÖ Cloud sync (opcional)

---

## üéØ Quick Wins (Bajo Esfuerzo, Alto Impacto)

1. **Preview en tiempo real** (2h, mejora experiencia)
2. **B√∫squeda fuzzy** (3h, mejor UX)
3. **Backup/Restore UI** (4h, evita p√©rdida de datos)
4. **Estad√≠sticas** (5h, engagement)
5. **Tests b√°sicos** (8h, calidad)

---

## üö® Bugs Conocidos a Corregir

1. ‚ùå **Snippets con variables no se expanden correctamente**
2. ‚ùå **Detector de abreviaturas no funciona**
3. ‚ö†Ô∏è **Quill editor puede tener scroll issues** (revisar height)
4. ‚ö†Ô∏è **Tags con espacios no se filtran bien** (trim en split)
5. ‚ö†Ô∏è **WebSocket no se usa en ning√∫n lugar**

---

## üì¶ Dependencias Sugeridas

```json
{
  "dependencies": {
    "axios": "^1.6.2",
    "iohook": "^0.9.3",        // NEW: Keyboard hooks
    "robotjs": "^0.6.0",        // NEW: Inserci√≥n texto
    "active-win": "^7.7.1",     // NEW: Detectar app activa
    "fuse.js": "^7.0.0",        // NEW: B√∫squeda fuzzy
    "chart.js": "^4.4.0"        // NEW: Stats charts
  },
  "devDependencies": {
    "electron": "^28.0.0",
    "electron-builder": "^24.9.1",
    "jest": "^29.7.0",          // NEW: Testing
    "eslint": "^8.55.0"         // NEW: Linting
  }
}
```

---

## üí° Conclusi√≥n

El proyecto tiene una **base s√≥lida** (90% completado) pero le faltan **funcionalidades cr√≠ticas** para ser usable:

**Bloqueantes:**
- ‚ùå Formulario de variables
- ‚ùå Detector de abreviaturas
- ‚ùå Tests

**Recomendaci√≥n:** Priorizar Sprint 1 (funcionalidad core) antes de agregar features nuevas.

**Tiempo estimado para MVP completo:** 3-4 semanas (1 dev full-time)

---

